# JollyAgent ReAct 框架 - 产品需求文档 (PRD)

**版本：** v0.1  
**作者：** @PM  
**日期：** 2025-08-01  
**状态：** 草稿

---

## 1. 概述

### 1.1 背景
JollyAgent 是一个基于 ReAct（思考-行动-观察）循环的 AI Agent 框架，旨在为各类用户提供智能化的任务执行和代码辅助能力。该框架支持工具调用、记忆管理和用户确认机制，能够在两周内快速落地最小可用版本。

### 1.2 问题陈述
当前用户在进行开发、运维、数据分析等任务时，需要频繁切换工具和上下文，缺乏统一的智能助手来协助执行复杂任务。传统的工作流程效率低下，且缺乏记忆能力来保持对话连续性。

### 1.3 目标
快速落地一个可扩展的 AI Agent，支持：
- ReAct 思考-行动-观察循环
- 工具调用（本地命令、MCP、文件系统）
- 记忆管理（对话级 RAG）
- 用户确认机制（命令行确认）
- 两周内发布最小可用版本（MVP）

---

## 2. 目标

### 2.1 主要目标
1. **功能完整性**：实现 ReAct 循环、工具调用、记忆管理、用户确认四大核心功能
2. **快速交付**：两周内完成 MVP 版本开发和测试
3. **用户友好**：提供简洁的 CLI 接口，降低使用门槛
4. **安全可靠**：通过 Docker 沙箱和用户确认机制确保执行安全

### 2.2 成功指标
- **功能指标**：四大核心功能全部实现并通过测试
- **性能指标**：单轮对话响应时间 < 2 秒（不含用户确认时间）
- **可用性指标**：CLI 接口响应流畅，交互体验良好
- **扩展性指标**：新增工具只需实现接口并注册，零侵入

---

## 3. 用户故事

### 3.1 开发者用户故事
- **US-001**：作为开发者，我希望 Agent 能回忆之前的对话内容，这样我就可以连续讨论同一个项目而不需要重复上下文
- **US-002**：作为开发者，我希望 Agent 能执行代码命令，这样我就可以快速测试和调试代码
- **US-003**：作为开发者，我希望 Agent 能读写文件，这样我就可以自动化文件操作任务
- **US-010**：作为开发者，我希望 Agent 能通过MCP协议调用外部工具，这样我就可以扩展Agent的能力而不需要修改核心代码

### 3.2 运维工程师用户故事
- **US-004**：作为运维工程师，我希望 Agent 能执行系统命令，这样我就可以快速诊断和修复问题
- **US-005**：作为运维工程师，我希望每个危险命令都需要确认，这样我就可以避免误操作

### 3.3 数据分析师用户故事
- **US-006**：作为数据分析师，我希望 Agent 能处理数据文件，这样我就可以快速进行数据预处理
- **US-007**：作为数据分析师，我希望 Agent 能记住我的分析历史，这样我就可以基于之前的分析继续工作

### 3.4 通用用户故事
- **US-008**：作为用户，我希望通过简单的命令行与 Agent 交互，这样我就可以在任何环境下使用
- **US-009**：作为用户，我希望 Agent 能撤销已执行的命令，这样我就可以在出错时快速恢复

---

## 4. 功能需求

### 4.1 核心功能

#### 4.1.1 ReAct 循环 (FR-001)
- **描述**：实现思考-行动-观察的循环机制
- **要求**：
  1. 系统必须支持 LLM 的思考过程输出
  2. 系统必须能够解析 LLM 的工具调用请求
  3. 系统必须能够执行工具并返回观察结果
  4. 系统必须支持多轮 ReAct 循环直到任务完成

#### 4.1.2 工具调用系统 (FR-002)
- **描述**：支持多种工具的安全调用，包括内置工具和MCP协议
- **要求**：
  1. 系统必须内置 run_shell、read_file、write_file 工具
  2. 系统必须支持 MCP（Model Context Protocol）协议调用
  3. 系统必须支持工具的自动注册和发现
  4. 系统必须提供工具调用的安全沙箱环境
  5. 系统必须支持工具调用的参数验证
  6. 系统必须支持MCP服务器的动态连接和断开

#### 4.1.3 记忆管理系统 (FR-003)
- **描述**：基于向量检索的对话记忆
- **要求**：
  1. 系统必须支持对话历史的向量化存储
  2. 系统必须支持基于相似度的记忆检索
  3. 系统必须支持时间倒序的记忆注入
  4. 系统必须支持本地记忆存储

#### 4.1.4 用户确认机制 (FR-004)
- **描述**：命令行形式的用户确认
- **要求**：
  1. 系统必须在执行写文件操作前要求用户确认
  2. 系统必须在执行系统命令前要求用户确认
  3. 系统必须支持命令的撤销功能
  4. 系统必须提供清晰的确认提示信息

### 4.2 接口功能

#### 4.2.1 CLI 接口 (FR-005)
- **描述**：命令行形式的交互接口
- **要求**：
  1. 系统必须支持 `python agent.py chat "message"` 格式
  2. 系统必须支持流式输出显示思考过程
  3. 系统必须支持交互式确认操作
  4. 系统必须提供清晰的帮助信息和错误提示

### 4.3 安全功能

#### 4.3.1 沙箱执行 (FR-006)
- **描述**：Docker 容器化的安全执行环境
- **要求**：
  1. 系统必须使用 Docker 容器隔离执行环境
  2. 系统必须限制容器内存使用为 128MB
  3. 系统必须禁用容器网络访问
  4. 系统必须只挂载工作目录到容器

---

## 5. 非目标（明确不包含的功能）

### 5.1 暂缓功能
- HTTP Web 接口
- 用户管理和身份验证
- 多用户并发支持
- 图形化确认弹窗界面
- 分布式记忆存储
- 文件差异的 UI 展示
- 多语言支持
- 插件市场和生态系统
- 高级权限管理系统
- 实时协作功能

### 5.2 扩展性功能（后续版本）
- HTTP API 接口
- 用户管理系统
- 自定义工具开发框架
- 工作流编排功能
- 性能监控和优化
- 企业级部署支持

---

## 6. 设计考虑

### 6.1 架构设计
```
┌────────────┐
│    CLI     │  Typer
└────┬───────┘
     │
┌────┴────────┐
│   Agent     │  ReAct Loop
│  ┌────────┐ │
│  │Memory  │ │  Chroma + OpenAI embeddings
│  └────────┘ │
│  ┌────────┐ │
│  │Executor│ │  工具分发 + Sandbox
│  └────────┘ │
└────┬────────┘
     │
┌────┴────────┐
│  Sandbox    │  Docker（本地 bash 备选）
└─────────────┘
```

### 6.2 核心抽象
| 层 | 类 / 接口 | 职责 |
|---|---|---|
| Tool | `class Tool(ABC)` | 工具描述 & 执行 |
| MCPClient | `class MCPClient` | MCP协议客户端 |
| Sandbox | `class Sandbox(ABC)` | 执行环境抽象 |
| Executor | `class Executor` | 工具调用解析和执行 |
| Memory | `class MemoryManager` | 记忆存储、检索、摘要 |
| Agent | `class Agent` | ReAct 循环协调 |

### 6.3 数据模型
```python
class Message(BaseModel):
    role: Literal["user", "assistant", "tool"]
    content: str
    timestamp: datetime
```

---

## 7. 技术考虑

### 7.1 技术栈
- **语言**：Python 3.11+
- **CLI框架**：Typer
- **向量数据库**：Chroma
- **容器化**：Docker SDK
- **重试机制**：tenacity
- **LLM集成**：支持硅基流动API（baseurl + model）
- **MCP协议**：支持Model Context Protocol客户端

### 7.2 技术约束
- 单轮响应时间 < 2 秒
- 内存使用限制 128MB
- 本地记忆存储
- 工具扩展零侵入

### 7.3 依赖关系
- OpenAI 兼容的 API 服务
- Docker 运行环境
- 本地文件系统访问权限
- MCP 服务器（可选，用于扩展工具能力）

---

## 8. 成功指标

### 8.1 功能指标
- [ ] ReAct 循环正常工作
- [ ] 工具调用系统完整
- [ ] 记忆管理功能可用
- [ ] 用户确认机制有效

### 8.2 性能指标
- [ ] 单轮对话响应时间 < 2 秒
- [ ] CLI 交互响应流畅
- [ ] 记忆检索准确率 > 80%

### 8.3 质量指标
- [ ] 代码覆盖率 > 80%
- [ ] 无高危安全漏洞
- [ ] 文档完整性 100%

---

## 9. 里程碑

| 日期 | 目标 | 交付物 |
|---|---|---|
| 8-03 | 最小骨架跑通 | ReAct + run_shell + 向量记忆 |
| 8-05 | CLI 接口完善 | Docker 沙箱 + 基础CLI |
| 8-08 | 用户确认机制 | 撤销功能 + 日志系统 |
| 8-10 | 发布准备 | README + 示例脚本，发布 v0.1 |

---

## 10. 风险与对策

| 风险 | 影响 | 概率 | 对策 |
|---|---|---|---|
| LLM 输出格式异常 | 高 | 中 | JSON mode + Pydantic + retry |
| 用户误操作 | 高 | 中 | 每条写/运行命令必须显式确认 |
| 向量库依赖问题 | 中 | 低 | 默认 SQLite+FAISS，可切换 Chroma |
| Docker 环境问题 | 中 | 低 | 提供本地 bash 备选方案 |
| API 服务不稳定 | 高 | 中 | 重试机制 + 降级策略 |

---

## 11. 开放问题

1. **性能优化**：如何进一步优化记忆检索的性能？
2. **安全增强**：是否需要添加更多的安全检查和限制？
3. **用户体验**：如何改进确认流程的用户体验？
4. **扩展性**：如何设计更好的工具扩展机制？

---

## 12. 附录

### 12.1 接口示例

#### CLI 示例
```bash
$ python agent.py chat "2+3=?"
$ python agent.py chat "写个 hello.py 并运行"
$ python agent.py chat "通过MCP连接到数据库并查询用户表"
$ python agent.py --help
```

#### 交互式确认示例
```
🤖 我需要执行以下命令：
   ls -la

⚠️  这是一个系统命令，需要您的确认
   输入 'y' 确认执行，'n' 取消，'s' 跳过：y

✅ 命令已执行，输出：
total 12
-rw-r--r-- 1 user user 1234 Aug 1 10:00 file.txt
```

### 12.2 分支策略
- main → dev → feature/xxx
- 代码审查要求
- 自动化测试要求
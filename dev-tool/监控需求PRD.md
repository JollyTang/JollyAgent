# JollyAgent 监控系统 PRD

## 1. 概述

### 1.1 背景
JollyAgent 是一个基于 ReAct 模式的 AI Agent 系统，目前缺乏完整的监控和可观测性能力。为了提升系统的可观测性、调试能力和后续的模型优化，需要集成 OpenTelemetry 监控系统，实现全流程的追踪、可视化和数据分析。

### 1.2 目标
构建一个完整的监控系统，实现 JollyAgent 执行过程的全链路追踪，提供可视化界面查看执行流程，并支持数据导出用于标注系统，为后续的提示词和模型优化提供数据支撑。

### 1.3 问题陈述
- 缺乏对 Agent 执行过程的详细监控
- 无法可视化查看执行流程和性能瓶颈
- 缺乏结构化的数据用于模型优化和标注
- 调试和问题排查困难

## 2. 目标

### 2.1 主要目标
1. **全链路追踪**: 实现用户查询到最终响应的完整执行链路追踪
2. **可视化监控**: 提供直观的流程图和瀑布图展示执行过程
3. **数据导出**: 支持结构化数据导出，便于标注系统使用
4. **性能分析**: 识别执行瓶颈，优化系统性能

### 2.2 成功指标
- 100% 的执行步骤被记录和追踪
- 可视化界面响应时间 < 2秒
- 数据导出格式标准化，支持 Excel 导入
- 系统性能影响 < 5%

## 3. 用户故事

### 3.1 开发者用户故事
- **作为开发者**，我希望能够实时查看 Agent 的执行流程，以便快速定位问题和优化性能
- **作为开发者**，我希望能够查看每个步骤的耗时，以便识别性能瓶颈
- **作为开发者**，我希望能够导出执行数据，以便进行模型优化和标注

### 3.2 运维用户故事
- **作为运维人员**，我希望能够监控系统的整体运行状态，以便及时发现异常
- **作为运维人员**，我希望能够查看历史执行记录，以便进行问题排查

### 3.3 产品经理用户故事
- **作为产品经理**，我希望能够分析用户查询模式，以便优化产品功能
- **作为产品经理**，我希望能够评估 Agent 的执行效果，以便制定改进计划

## 4. 功能需求

### 4.1 数据收集层
1. **OpenTelemetry 集成**
   - 集成 OpenTelemetry Python SDK
   - 配置 trace 和 span 收集
   - 实现自定义 instrumentation

2. **执行步骤追踪**
   - 用户输入接收追踪
   - Agent 思考过程（Think）追踪
   - 工具调用（Act）追踪
   - 工具执行结果（Observe）追踪
   - 最终响应生成追踪

3. **元数据收集**
   - 时间戳（开始时间、结束时间、耗时）
   - 输入/输出内容
   - 执行状态（成功/失败）
   - 错误信息和堆栈跟踪
   - 用户会话信息
   - 工具调用参数和结果

### 4.2 数据存储层
1. **本地文件存储**
   - JSON 格式的结构化日志
   - 按日期和会话ID组织文件
   - 支持日志轮转和压缩

2. **数据格式规范**
   ```json
   {
     "session_id": "string",
     "conversation_id": "string",
     "user_id": "string",
     "timestamp": "ISO8601",
     "spans": [
       {
         "span_id": "string",
         "parent_span_id": "string",
         "name": "string",
         "start_time": "ISO8601",
         "end_time": "ISO8601",
         "duration_ms": "number",
         "attributes": {
           "step_type": "think|act|observe|response",
           "content": "string",
           "tool_name": "string",
           "status": "success|error",
           "error_message": "string"
         }
       }
     ]
   }
   ```

### 4.3 可视化层
1. **Grafana 集成**
   - 配置 Grafana 数据源
   - 创建自定义仪表板
   - 实现实时数据展示

2. **可视化组件**
   - 执行流程图（类似 Jaeger trace view）
   - 瀑布图（类似 Chrome DevTools）
   - 性能指标图表
   - 错误率统计图

3. **交互功能**
   - 会话搜索和过滤
   - 时间范围选择
   - 执行步骤展开/折叠
   - 详细信息查看

### 4.4 数据导出层
1. **Excel 导出功能**
   - 支持按会话导出
   - 支持按时间范围导出
   - 支持自定义字段选择

2. **导出字段**
   - 用户查询内容
   - Agent 思考过程
   - 工具调用详情
   - 执行结果
   - 耗时统计
   - 错误信息

3. **数据格式**
   - 标准 Excel 格式（.xlsx）
   - 支持多工作表
   - 包含元数据说明

### 4.5 性能监控（可选）
1. **系统指标**
   - CPU 使用率
   - 内存使用情况
   - 网络 I/O
   - 磁盘 I/O

2. **应用指标**
   - 请求响应时间
   - 错误率统计
   - 并发用户数
   - 工具调用频率

## 5. 非目标（Out of Scope）

1. **实时流处理**: 不包含 Kafka -> Flink -> 标注系统的实时流处理
2. **复杂告警**: 不包含复杂的告警规则和通知机制
3. **用户权限管理**: 不包含多用户权限控制
4. **数据加密**: 不包含敏感数据加密功能
5. **分布式追踪**: 不包含跨服务的分布式追踪

## 6. 设计考虑

### 6.1 架构设计
```
用户请求 -> JollyAgent -> OpenTelemetry SDK -> 本地文件存储
                                    ↓
                              Grafana 可视化
                                    ↓
                              数据导出 (Excel)
```

### 6.2 UI/UX 要求
- 简洁直观的界面设计
- 响应式布局，支持不同屏幕尺寸
- 快速加载和流畅交互
- 清晰的数据展示和导航

### 6.3 性能要求
- 监控系统对主业务的影响 < 5%
- 可视化界面响应时间 < 2秒
- 支持至少 1000 个并发会话的监控
- 数据存储空间增长可控

## 7. 技术考虑

### 7.1 技术栈选择
- **监控框架**: OpenTelemetry Python SDK
- **可视化工具**: Grafana
- **数据存储**: 本地 JSON 文件
- **数据导出**: pandas + openpyxl
- **Web 服务**: FastAPI（可选，用于 Grafana 数据源）

### 7.2 集成方式
- 使用 OpenTelemetry SDK 直接集成到 Agent 代码中
- 配置 OTLP exporter 输出到本地文件
- 使用 Grafana 的 JSON 数据源插件

### 7.3 依赖关系
- OpenTelemetry Python SDK
- Grafana
- pandas
- openpyxl
- FastAPI（可选）

## 8. 成功指标

### 8.1 功能指标
- [ ] 100% 的执行步骤被正确记录
- [ ] 可视化界面能够正确展示执行流程
- [ ] 数据导出功能正常工作
- [ ] 系统性能影响控制在 5% 以内

### 8.2 质量指标
- [ ] 监控数据准确性 99%+
- [ ] 可视化界面响应时间 < 2秒
- [ ] 数据导出成功率 100%
- [ ] 系统稳定性 99.9%

### 8.3 用户体验指标
- [ ] 开发者能够快速定位问题
- [ ] 运维人员能够有效监控系统
- [ ] 产品经理能够分析用户行为

## 9. 开放问题

1. **数据保留策略**: 监控数据需要保留多长时间？
2. **存储容量**: 预计每日产生的监控数据量？
3. **并发支持**: 系统需要支持的最大并发用户数？
4. **扩展性**: 未来是否需要支持分布式部署？
5. **安全性**: 是否需要考虑监控数据的安全保护？

## 10. 实施计划

### 10.1 第一阶段：基础监控
- 集成 OpenTelemetry SDK
- 实现基本的数据收集
- 配置本地文件存储

### 10.2 第二阶段：可视化
- 集成 Grafana
- 创建基础仪表板
- 实现流程图展示

### 10.3 第三阶段：数据导出
- 实现 Excel 导出功能
- 优化数据格式
- 完善元数据

### 10.4 第四阶段：优化完善
- 性能优化
- 用户体验改进
- 文档完善

## 11. 风险评估

### 11.1 技术风险
- OpenTelemetry 集成复杂度
- 性能影响控制
- 数据格式兼容性

### 11.2 项目风险
- 开发时间估算
- 依赖第三方工具
- 数据迁移需求

### 11.3 缓解措施
- 充分的技术调研
- 渐进式实施
- 完善的测试计划 